name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ ì €ì¥
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # known_hosts ì„¤ì •
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts || true
          
          echo "âœ… SSH setup completed"
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"

      - name: Test SSH Connection
        timeout-minutes: 2
        run: |
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"
          echo "íƒ€ì„ì•„ì›ƒ: 60ì´ˆ"
          echo ""
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 60ì´ˆ)
          if ssh -o ConnectTimeout=60 -o StrictHostKeyChecking=no -o ServerAliveInterval=10 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} echo "âœ… SSH ì—°ê²° ì„±ê³µ" 2>&1; then
            echo "âœ… SSH ì—°ê²° í…ŒìŠ¤íŠ¸ í†µê³¼"
          else
            echo ""
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            echo ""
            echo "ğŸ”§ ì¦‰ì‹œ í™•ì¸í•  ì‚¬í•­:"
            echo ""
            echo "1. EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ì¸ìŠ¤í„´ìŠ¤ê°€ 'running' ìƒíƒœì¸ì§€ í™•ì¸"
            echo ""
            echo "2. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ë³´ì•ˆ ê·¸ë£¹ > ì¸ë°”ìš´ë“œ ê·œì¹™"
            echo "   - í¬íŠ¸ 22 (SSH) ê·œì¹™ì´ ìˆì–´ì•¼ í•¨"
            echo "   - ì†ŒìŠ¤: 0.0.0.0/0 ë˜ëŠ” íŠ¹ì • IP ë²”ìœ„"
            echo ""
            echo "3. ê³µê°œ IP ì£¼ì†Œ í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ì¸ìŠ¤í„´ìŠ¤ > ë„¤íŠ¸ì›Œí‚¹ íƒ­"
            echo "   - ê³µê°œ IPv4 ì£¼ì†Œë¥¼ í™•ì¸í•˜ê³  GitHub Secretsì˜ EC2_HOSTì™€ ë¹„êµ"
            echo ""
            echo "4. ë¡œì»¬ì—ì„œ SSH ì—°ê²° í…ŒìŠ¤íŠ¸"
            echo "   ssh -i ~/.ssh/your_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
            echo "   (ë¡œì»¬ì—ì„œë„ ì—°ê²°ì´ ì•ˆ ë˜ë©´ EC2 ì„¤ì • ë¬¸ì œì…ë‹ˆë‹¤)"
            echo ""
            exit 1
          fi

      - name: Deploy to EC2
        run: |
          set -e
          
          # EC2ì—ì„œ git pull ë° ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=60 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/cinecollector || {
              echo "âš ï¸  ë°°í¬ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤..."
              mkdir -p ~/cinecollector
              cd ~/cinecollector
              
              # Git ì €ì¥ì†Œ í´ë¡  (ì²˜ìŒ ë°°í¬ì¸ ê²½ìš°)
              if [ ! -d ".git" ]; then
                echo "ğŸ“¥ Git ì €ì¥ì†Œ í´ë¡  ì¤‘..."
                git clone https://github.com/${{ github.repository }}.git .
              fi
            }
            
            # Git pullë¡œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "scripts/deploy.sh" ]; then
              chmod +x scripts/deploy.sh
              ./scripts/deploy.sh
            else
              echo "âš ï¸  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
