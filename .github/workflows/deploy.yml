name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ ì €ì¥
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # known_hosts ì„¤ì •
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts || true
          
          echo "âœ… SSH setup completed"
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"

      - name: Test SSH Connection
        timeout-minutes: 2
        run: |
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "EC2_USER: ${{ secrets.EC2_USER }}"
          echo "íƒ€ì„ì•„ì›ƒ: 60ì´ˆ"
          echo ""
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 60ì´ˆ)
          if ssh -o ConnectTimeout=60 -o StrictHostKeyChecking=no -o ServerAliveInterval=10 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} echo "âœ… SSH ì—°ê²° ì„±ê³µ" 2>&1; then
            echo "âœ… SSH ì—°ê²° í…ŒìŠ¤íŠ¸ í†µê³¼"
          else
            echo ""
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            echo ""
            echo "ğŸ”§ ì¦‰ì‹œ í™•ì¸í•  ì‚¬í•­:"
            echo ""
            echo "1. EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ì¸ìŠ¤í„´ìŠ¤ê°€ 'running' ìƒíƒœì¸ì§€ í™•ì¸"
            echo ""
            echo "2. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ë³´ì•ˆ ê·¸ë£¹ > ì¸ë°”ìš´ë“œ ê·œì¹™"
            echo "   - í¬íŠ¸ 22 (SSH) ê·œì¹™ì´ ìˆì–´ì•¼ í•¨"
            echo "   - ì†ŒìŠ¤: 0.0.0.0/0 ë˜ëŠ” íŠ¹ì • IP ë²”ìœ„"
            echo ""
            echo "3. ê³µê°œ IP ì£¼ì†Œ í™•ì¸"
            echo "   - AWS ì½˜ì†” > EC2 > ì¸ìŠ¤í„´ìŠ¤ > ë„¤íŠ¸ì›Œí‚¹ íƒ­"
            echo "   - ê³µê°œ IPv4 ì£¼ì†Œë¥¼ í™•ì¸í•˜ê³  GitHub Secretsì˜ EC2_HOSTì™€ ë¹„êµ"
            echo ""
            echo "4. ë¡œì»¬ì—ì„œ SSH ì—°ê²° í…ŒìŠ¤íŠ¸"
            echo "   ssh -i ~/.ssh/your_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
            echo "   (ë¡œì»¬ì—ì„œë„ ì—°ê²°ì´ ì•ˆ ë˜ë©´ EC2 ì„¤ì • ë¬¸ì œì…ë‹ˆë‹¤)"
            echo ""
            exit 1
          fi

      - name: Deploy to EC2
        run: |
          set -e
          
          # EC2ì—ì„œ git pull ë° ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=60 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            echo "ğŸš€ CineCollector ë°°í¬ ì‹œì‘..."
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/cinecollector
            cd ~/cinecollector
            
            # .env íŒŒì¼ ë¯¸ë¦¬ ë°±ì—… (git ì‘ì—… ì „ì—)
            if [ -f .env ]; then
              echo "ğŸ’¾ .env íŒŒì¼ ë°±ì—… ì¤‘..."
              cp .env ../.env.backup
              echo "âœ… .env íŒŒì¼ ë°±ì—… ì™„ë£Œ"
            fi
            
            # Git ì €ì¥ì†Œ í™•ì¸ ë° ì´ˆê¸°í™”
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Git ì €ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. í´ë¡  ì¤‘..."
              if [ "$(ls -A . 2>/dev/null)" ]; then
                echo "âš ï¸  ê¸°ì¡´ íŒŒì¼ì„ ë°±ì—…í•©ë‹ˆë‹¤..."
                mkdir -p ../cinecollector_backup
                mv * ../cinecollector_backup/ 2>/dev/null || true
                mv .* ../cinecollector_backup/ 2>/dev/null || true
              fi
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi
            
            # .env íŒŒì¼ ë³µì› (git ì‘ì—… í›„)
            if [ -f ../.env.backup ]; then
              echo "ğŸ“‹ .env íŒŒì¼ ë³µì› ì¤‘..."
              cp ../.env.backup .env
              echo "âœ… .env íŒŒì¼ ë³µì› ì™„ë£Œ"
            elif [ -f ../cinecollector_backup/.env ]; then
              echo "ğŸ“‹ ë°±ì—… ë””ë ‰í† ë¦¬ì—ì„œ .env íŒŒì¼ ë³µì› ì¤‘..."
              cp ../cinecollector_backup/.env .env
              echo "âœ… .env íŒŒì¼ ë³µì› ì™„ë£Œ"
            fi
            
            # .env íŒŒì¼ í™•ì¸
            if [ ! -f .env ]; then
              echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi
            
            # ========== Backend ë°°í¬ ==========
            echo ""
            echo "ğŸ”¨ Backend ë°°í¬ ì‹œì‘..."
            
            cd backend
            
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            echo "ğŸ“¦ Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            docker build -t cinecollector-backend .
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ ê¸°ì¡´ Backend ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker stop cinecollector-backend 2>/dev/null || true
            docker rm cinecollector-backend 2>/dev/null || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "â–¶ï¸  Backend ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker run --rm -d -p 8080:8080 \
              --env-file ../.env \
              --name cinecollector-backend \
              --add-host=host.docker.internal:host-gateway \
              cinecollector-backend
            
            echo "âœ… Backend ë°°í¬ ì™„ë£Œ!"
            
            cd ..
            
            # ========== Frontend ë°°í¬ ==========
            echo ""
            echo "ğŸ”¨ Frontend ë°°í¬ ì‹œì‘..."
            
            cd frontend
            
            # Frontend ë¹Œë“œ
            if [ -f "package.json" ]; then
              echo "ğŸ“¦ Frontend ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
              npm ci
              
              echo "ğŸ”¨ Frontend ë¹Œë“œ ì‹¤í–‰ ì¤‘..."
              npm run build
              
              if [ ! -d "build" ]; then
                echo "âŒ Frontend ë¹Œë“œ ë””ë ‰í† ë¦¬(build)ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                exit 1
              fi
              echo "âœ… Frontend ë¹Œë“œ ì™„ë£Œ: $(du -sh build | cut -f1)"
            else
              echo "âš ï¸  frontend/package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
            echo "ğŸ“ Nginx ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
            sudo tee /etc/nginx/sites-available/cinecollector > /dev/null <<NGINX_EOF
            server {
                listen 80;
                server_name _;
                root $HOME/cinecollector/frontend/build;
                index index.html;
            
                # Gzip ì••ì¶• ì„¤ì •
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
            
                # ì •ì  íŒŒì¼ ìºì‹±
                location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            
                # SPA ë¼ìš°íŒ…ì„ ìœ„í•œ ì„¤ì •
                location / {
                    try_files \$uri \$uri/ /index.html;
                }
            
                # API í”„ë¡ì‹œ ì„¤ì •
                location /api {
                    proxy_pass http://localhost:8080;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            NGINX_EOF
            
            # Nginx ì‚¬ì´íŠ¸ í™œì„±í™”
            sudo ln -sf /etc/nginx/sites-available/cinecollector /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
            echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "âœ… Frontend ë°°í¬ ì™„ë£Œ!"
            
            cd ..
            
            # í—¬ìŠ¤ ì²´í¬
            echo ""
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
            sleep 10
            
            # Backend í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1 || curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Backendê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "âš ï¸  Backend í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              docker logs cinecollector-backend
            fi
            
            # Frontend í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:80 > /dev/null 2>&1; then
              echo "âœ… Frontendê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "âš ï¸  Frontend í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. Nginx ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              sudo tail -n 20 /var/log/nginx/error.log
            fi
            
            echo ""
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo ""
            echo "ğŸ“Š ì‹¤í–‰ ìƒíƒœ:"
            docker ps | grep cinecollector-backend || echo "Backend ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            sudo systemctl status nginx --no-pager -l | head -n 5
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
