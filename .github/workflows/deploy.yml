name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          # SSH 디렉토리 생성
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH 키 저장
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # known_hosts 설정
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts || true
          
          echo "✅ SSH setup completed"

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Build Backend
        working-directory: ./backend
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # Backend: 빌드된 JAR만 복사하고 프로덕션 Dockerfile 사용
          mkdir -p deploy/backend/build/libs
          cp backend/build/libs/*.jar deploy/backend/build/libs/
          cp backend/Dockerfile.prod deploy/backend/Dockerfile
          # Frontend: 빌드된 파일만 복사하고 프로덕션 Dockerfile 사용
          cp -r frontend/build deploy/frontend/
          cp frontend/Dockerfile.prod deploy/frontend/Dockerfile
          cp frontend/nginx.conf deploy/frontend/
          # Docker Compose 및 기타 설정 파일 복사
          cp docker-compose.yml deploy/
          # 배포 스크립트 복사
          cp scripts/deploy.sh deploy/
          chmod +x deploy/deploy.sh
          # 환경 변수 템플릿 복사 (파일이 있는 경우에만)
          if [ -f env.example ]; then
            cp env.example deploy/.env.example
          fi

      - name: Deploy to EC2
        run: |
          set -e
          
          # EC2에 배포 패키지 전송 (압축하여 전송)
          tar -czf deploy.tar.gz -C deploy .
          scp -o StrictHostKeyChecking=yes -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i ~/.ssh/deploy_key deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          # EC2에서 배포 스크립트 실행
          ssh -o StrictHostKeyChecking=yes -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=30 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # 배포 디렉토리 생성
            mkdir -p ~/cinecollector
            cd ~/cinecollector
            
            # 기존 파일 백업 (선택사항)
            if [ -d "backend" ] || [ -d "frontend" ]; then
              mkdir -p backup
              mv backend frontend docker-compose.yml backup/ 2>/dev/null || true
            fi
            
            # 새 파일 압축 해제
            tar -xzf /tmp/deploy.tar.gz -C .
            rm /tmp/deploy.tar.gz
            
            # 배포 스크립트 실행
            chmod +x deploy.sh
            ./deploy.sh
          EOF
          
          # 로컬 임시 파일 정리
          rm -rf deploy deploy.tar.gz

      - name: Cleanup
        if: always()
        run: |
          rm -rf deploy
          rm -f ~/.ssh/deploy_key
