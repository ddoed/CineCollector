name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ ì €ì¥
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # known_hosts ì„¤ì •
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts || true
          
          echo "âœ… SSH setup completed"

      - name: Deploy to EC2
        run: |
          set -e
          
          # EC2ì—ì„œ git pull ë° ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=60 -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/cinecollector || {
              echo "âš ï¸  ë°°í¬ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤..."
              mkdir -p ~/cinecollector
              cd ~/cinecollector
              
              # Git ì €ì¥ì†Œ í´ë¡  (ì²˜ìŒ ë°°í¬ì¸ ê²½ìš°)
              if [ ! -d ".git" ]; then
                echo "ğŸ“¥ Git ì €ì¥ì†Œ í´ë¡  ì¤‘..."
                git clone https://github.com/${{ github.repository }}.git .
              fi
            }
            
            # Git pullë¡œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "scripts/deploy.sh" ]; then
              chmod +x scripts/deploy.sh
              ./scripts/deploy.sh
            else
              echo "âš ï¸  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
